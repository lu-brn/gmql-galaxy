<tool id="gmlq_rest_datasets_upload" name="GMLQ Upload Dataset" version="0.1.1">
  <command><![CDATA[
      python $__tool_directory__/gmql_rest_datasets.py $output
	  -user=$authToken
	  -dataset=$name
	  #if $upload.source == 'remote'
	   -cmd=upload_url
	   #if $upload.schema.schema_type == "custom" :
	    -schema=$upload.schema.schema_url
	   #else :
	    -schema=$upload.schema.schema_type
	   #end if
	   -samples=$upload.samples_urls
	  #else:
	   -cmd=upload
	   #if $upload.schema_local.schema_type == "custom" :
	    -schema=$upload.schema_local.schema
	   #else :
	    -schema=$upload.schema_local.schema_type
	   #end if
	    -samples=$samples
	  #end if
	    -add_output=$updated_list
	  ]]></command>
    <configfiles>
        <configfile name="samples" >#if $upload.source == 'local' :
            #if $upload.samples.is_collection :
            #for $i in $upload.samples
            #if $i.is_collection :
            #for $file in $i
            #echo '%s\t%s\n'%($file.element_identifier,$file)
            #end for
            #else :
            #echo '%s\t%s\n'%($i.name,$i)
            #end if
            #end for
            #else :
            #echo '%s\t%s\n'%($upload.samples.name,$upload.samples)
            #end if
            #end if
        </configfile>
    </configfiles>
  <code file="dynamic_utils.py">
      <hook validate_input="validate_upload" />
  </code>
  <inputs>
	<param format="gmql_user" name="authToken" type="data" label="Select user" />
	<param name="name" type="text" label="Name of the new dataset" >
		<validator type="regex" message="Only alphanumeric characters and underscore are allowed">[\w]+$</validator>
	</param>
	<conditional name="upload">
		<param name="source" type="select" label="Upload from local or another server" display="radio" multiple="false">
            <option value="local">Local</option>
            <option value="remote">Provide Urls</option>
        </param>
		<when value="remote">
			<conditional name="schema">
				<param name="schema_type" type="select" label="File type" >
					<option value="bed">bed</option>
					<option value="bedGraph">bedGraph</option>
					<option value="NarrowPeak">NarrowPeak</option>
					<option value="BroadPeak">BroadPeak</option>
					<option value="vcf">vcf</option>
					<option value="custom">Custom</option>
				</param>
				<when value="custom">
					<param name="schema_url" type="text" format="text" size="80" label="Schema URL">
						<validator type="regex" message="Does not look as a valid url">[\w:/\.\?@#+-=&amp;]+$</validator>
                        <sanitizer>
                             <valid initial="default">
                                <remove value="&amp;"/>
                             </valid>
                            <mapping initial="default">
                                <add source="&amp;" target="__amp__" />
                            </mapping>
                        </sanitizer>
					</param>
				</when>
			</conditional>
			<param name="samples_urls" type="text" format="text" area="True" size="10x80" label="Samples URLs">
				<validator type="regex" message="Please one url per line">[\w:/\.\?@#+-=%&amp;]+(\n[\w:/\.\?@#+-=%&amp;]+)*$</validator>
                <sanitizer>
                    <valid initial="default">
                        <remove value="&amp;"/>
                    </valid>
                    <mapping initial="default">
                        <add source="X" target="__cn__" />
                        <add source="&amp;" target="__amp__" />
                    </mapping>
                </sanitizer>
			</param>
        </when>
		<when value="local">
            <conditional name="schema_local">
				<param name="schema_type" type="select" label="File type" >
					<option value="bed">bed</option>
					<option value="bedGraph">bedGraph</option>
					<option value="NarrowPeak">NarrowPeak</option>
					<option value="BroadPeak">BroadPeak</option>
					<option value="vcf">vcf</option>
					<option value="custom">Custom</option>
				</param>
				<when value="custom">
					<param name="schema" type="data" format="xml" label="Schema XML Definition" />
				</when>
			</conditional>
			<param name="samples" type="data" label="Data: " />
		</when>
	</conditional>
  </inputs>
  <outputs>
     <data format="tabular" name="output" label="${name} updated samples" >
            <actions>
                <action name="column_names" type="metadata" default="id,sample,ext" />
            </actions>
      </data>
      <data format="gmql_repository" name="updated_list" label="${authToken.name.split()[0].rstrip('')} GMQL Datasets">
           <actions>
                <action name="column_names" type="metadata" default="dataset,owner" />
            </actions>
       </data>
  </outputs>
  <help>
  **What it does**
  
  It allows to upload a new dataset on the user's private space. 
  
  **How it works**

  The user must provide a name for the new dataset, the locations of the samples and their reference schema.
  It is possible to either provide remote locations or pick samples from local.
  
  </help>	
	
</tool>
