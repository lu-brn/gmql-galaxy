<tool id="gmql_rest_queries_editor" name="GMLQ Query Editor" version="0.1.1">
  <description>Compile and run GMQL queries (Advanced Mode)</description>
    <command><![CDATA[
      #if $mode.exec_mode == "execute" :
       mkdir -p results && cd results &&
       python $__tool_directory__/gmql_rest_queries.py
       -user=$authToken
       -cmd=execute
       -name=$query_name
       -query=$query_text
       -log=$log
       -format=$mode.out_format
       -add_output=$updated_list
      #else :
       python $__tool_directory__/gmql_rest_queries.py
       -user=$authToken
       -cmd=$mode.exec_mode
       -name=$query_name
       -query=$query_text
       -log=$log
      #end if
	  ]]></command>
  <configfiles>
      <!--<configfile name="schema_out" >
      </configfile> -->
      <configfile name="query_text" >#echo '%s'%($query)</configfile>
  </configfiles>
   <inputs>
	<param format="gmql_user" name="authToken" type="data" label="Select user">
            <validator type="expression" message="User has expired">open(value.file_name,'r').readline().rstrip('\n').split('\t')[2] == 'True'</validator>
    </param>
	<param name="query_name" type="text" label="Query Name" >
		<validator type="regex" message="Only alphanumeric characters and underscore allowed. It must begin with
                                         letter or underscore.">[a-zA-Z_]([\w]+)?$</validator>
	</param>
    <param name="query" type="text" area="true" label="Query" >
        <sanitizer>
            <valid initial="default">
                <add value=";"/>
            </valid>
            <mapping initial="default">
                <add source="X" target="__cn__" />
            </mapping>
        </sanitizer>
    </param>
     <conditional name="mode">
      <param name="exec_mode" type="select" label="Compile or run query">
		<option value="compile">Compile query</option>
        <option value="execute">Execute query</option>
      </param>
      <when value="execute">
			<param name="out_format" type="select" label="Output format">
                <option value="gdm">TAB Delimited (GDM)</option>
                <option value="gtf">GTF</option>
            </param>
      </when>
    </conditional>
    </inputs>
	<outputs>
        <data format="txt" name="log" label="${query_name} query log" />
        <collection name="query_results" type="list:list" label="${query_name}">
            <discover_datasets pattern="(?P&lt;identifier_0&gt;[\w]+)#(?P&lt;identifier_1&gt;[\w]+)\.(?P&lt;ext&gt;[^\._]+)?" directory="results" />
            <filter>mode['exec_mode'] == 'execute'</filter>
        </collection>
        <data format="gmql_repository" name="updated_list" label="${authToken.name.split()[0].rstrip('')} GMQL Datasets">
            <filter>mode['exec_mode'] == 'execute'</filter>
            <actions>
                <action name="column_names" type="metadata" default="dataset,owner" />
           </actions>
       </data>
	</outputs>

    <help>
        <!-- TODO -->
    </help>

</tool>
